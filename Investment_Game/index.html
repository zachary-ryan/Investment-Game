<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Investment Game</title>
<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f0f5;
        margin: 0;
    }

    .game-container {
        width: 300px;
        padding: 20px;
        border-radius: 10px;
        background-color: #3366cc;
        color: #fff;
        text-align: center;
    }

    .info-bar {
        font-size: 0.9em;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .investment-card {
        background-color: #ffffff;
        color: #333;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .investment-card h3 {
        margin: 5px 0;
        font-size: 1.1em;
        color: #3366cc;
    }

    .investment-card .value {
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    input[type="number"], input[type="range"] {
        width: 100%;
    }

    input[type="range"] {
        margin-top: 5px;
    }

    .submit-button {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 10px 20px;
        font-size: 1em;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
    }

    .submit-button:disabled {
        background-color: #888;
    }
</style>
</head>
<body>

<div class="game-container">
    <div class="info-bar">
        <div>Budget Remaining: <span id="budget">$10,000</span></div>
        <div>Total Value: <span id="totalValue">0</span></div>
    </div>
    <h2>Period <span id="currentPeriod">1</span> of <span id="totalPeriods">6</span></h2>

    <!-- Investment Card -->
    <div class="investment-card">
        <h3>Investment</h3>
        <div class="value">Cost: $0 - $100 | Value: <span id="investmentValue">123</span></div>
        <input type="number" id="investmentInput" min="0" max="100" placeholder="Enter Amount" oninput="syncSlider('investmentInput', 'investmentSlider')">
        <div class="slider-container">
            <input type="range" id="investmentSlider" min="0" max="100" oninput="syncInput('investmentSlider', 'investmentInput')">
        </div>
    </div>

    <button class="submit-button" onclick="submitRound()">Submit</button>
</div>

<script>
    // Main game variables
    let budget = 500;         // Starting budget of $10,000
    let totalValue = 0;         // Initial total value is zero
    let currentRound = 1;       // Start from round 1
    const totalRounds = 10;      // Total number of rounds
    let shockStandardDeviation = 0.3; // Default standard deviation for lognormal shocks
    let useShocks = false;      // Toggle to determine if shocks are used
    
    // Display initial values on the UI
    document.getElementById("budget").textContent = `$${budget.toLocaleString()}`;
    document.getElementById("totalValue").textContent = totalValue;
    document.getElementById("currentPeriod").textContent = currentRound;
    document.getElementById("totalPeriods").textContent = totalRounds;

    // Function to generate a lognormal shift (used for generating shocks each period)
    function getLognormalShift(mean, stdev) {
        const u1 = Math.random();
        const u2 = Math.random();
        const standardNormal = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        return Math.exp(mean + stdev * standardNormal);
    }

    // Function to update investment card values each round
    function generateInvestmentValues() {
        let investmentValue;
        let investmentCost;

        if (useShocks) {
            const shock = getLognormalShift(0, shockStandardDeviation);
            investmentValue = Math.round(shock * 100);
        } else {
            investmentValue = Math.round(Math.random() * 100);
        }

        investmentCost = Math.round(Math.random() * 100);

        document.querySelector("#investmentValue").textContent = investmentValue;

        return {
            investmentValue,
            investmentCost
        };
    }
    

    let currentInvestmentData = generateInvestmentValues();

    function syncInput(sliderId, inputId) {
        const slider = document.getElementById(sliderId);
        const input = document.getElementById(inputId);
        input.value = slider.value;
        validateInvestment(inputId, sliderId);
    }

    function syncSlider(inputId, sliderId) {
        const input = document.getElementById(inputId);
        const slider = document.getElementById(sliderId);
        let value = parseInt(input.value);
        if (isNaN(value)) {
            value = 0;
        }
        input.value = value;
        slider.value = value;
        validateInvestment(inputId, sliderId);
    }

    function validateInvestment(inputId, sliderId) {
        const input = document.getElementById(inputId);
        const slider = document.getElementById(sliderId);
        const maxAllowable = Math.min(parseInt(input.getAttribute("max")), budget);

        if (parseInt(input.value) > maxAllowable) {
            input.value = maxAllowable;
            slider.value = maxAllowable;
        } else {
            slider.value = input.value;
        }
    }

    function submitRound() {
        const investmentAmount = parseInt(document.getElementById("investmentInput").value) || 0;
        const investmentValue = currentInvestmentData.investmentValue;
        const investmentCost = currentInvestmentData.investmentCost;

        if (investmentAmount >= investmentCost) {
            totalValue += investmentValue;
            alert(`Investment successful! Added $${investmentValue} to total value.`);
        } else {
            alert("Investment failed. Not enough to meet the required cost.");
        }

        budget -= investmentAmount;
        document.getElementById("budget").textContent = `$${budget.toLocaleString()}`;
        document.getElementById("totalValue").textContent = totalValue;

        if (currentRound < totalRounds) {
            currentRound++;
            document.getElementById("currentPeriod").textContent = currentRound;
            currentInvestmentData = generateInvestmentValues();
            resetInputs();
        } else {
            alert("Game over!");
            saveGameResults();
        }
    }

    function resetInputs() {
        document.getElementById("investmentInput").value = '';
        document.getElementById("investmentSlider").value = 0;
    }

// Array to store game results for each round
const gameData = [];

// Function to save data for each round
function saveRoundData(round, valueDisplayed, userSpent, actualCost, remainingBudget, totalValue) {
    gameData.push({
        Round: round,
        ValueDisplayed: valueDisplayed,
        UserSpent: userSpent,
        ActualCost: actualCost,
        RemainingBudget: remainingBudget,
        TotalValue: totalValue
    });
}

// Function to convert game data to CSV format
function convertToCSV(data) {
    const headers = [
        "Round", "ValueDisplayed", "UserSpent", "ActualCost", "RemainingBudget", "TotalValue"
    ];

    const csvRows = data.map(row => headers.map(header => row[header]).join(","));
    return [headers.join(","), ...csvRows].join("");
}

// Function to download CSV file
function downloadCSV(filename, csvContent) {
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.setAttribute("hidden", "");
    a.setAttribute("href", url);
    a.setAttribute("download", filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Call this function after the final round is completed
function saveGameResults() {
    // Ask the user if they want to save the game results
    const saveConfirmation = confirm("Would you like to save your game results?");

    // If the user confirms, generate and download the CSV file
    if (saveConfirmation) {
        const csvContent = convertToCSV(gameData);
        const filename = `game_results.csv`;
        downloadCSV(filename, csvContent);
        alert("Your game results have been saved.");
    } else {
        alert("Game results were not saved.");
    }
}

// Update submitRound function to save round data
function submitRound() {
    const investmentAmount = parseInt(document.getElementById("investmentInput").value) || 0;
    const investmentValue = currentInvestmentData.investmentValue;
    const investmentCost = currentInvestmentData.investmentCost;

    if (investmentAmount >= investmentCost) {
        totalValue += investmentValue;
        alert(`Investment successful! Added $${investmentValue} to total value.`);
    } else {
        alert("Investment failed. Not enough to meet the required cost.");
    }

    budget -= investmentAmount;
    document.getElementById("budget").textContent = `$${budget.toLocaleString()}`;
    document.getElementById("totalValue").textContent = totalValue;

    // Save round data
    saveRoundData(currentRound, investmentValue, investmentAmount, investmentCost, budget, totalValue);

    if (currentRound < totalRounds) {
        currentRound++;
        document.getElementById("currentPeriod").textContent = currentRound;
        currentInvestmentData = generateInvestmentValues();
        resetInputs();
    } else {
        alert("Game over!");
        saveGameResults();
    }
}
</script>

</body>
</html>
