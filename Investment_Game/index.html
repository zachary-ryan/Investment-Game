<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Investment Game</title>
<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f0f5;
        margin: 0;
    }

    .game-container {
        width: 300px;
        padding: 20px;
        border-radius: 10px;
        background-color: #3366cc;
        color: #fff;
        text-align: center;
    }

    .info-bar {
        font-size: 0.9em;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .investment-card {
        background-color: #ffffff;
        color: #333;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .investment-card h3 {
        margin: 5px 0;
        font-size: 1.1em;
        color: #3366cc;
    }

    .investment-card .value {
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    input[type="number"], input[type="range"] {
        width: 100%;
    }

    input[type="range"] {
        margin-top: 5px;
    }

    .submit-button {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 10px 20px;
        font-size: 1em;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
    }

    .submit-button:disabled {
        background-color: #888;
    }
</style>
</head>
<body>

<div class="game-container">
    <div class="info-bar">
        <div>Budget Remaining: <span id="budget">$500</span></div>
        <div>Total Value: <span id="totalValue">0</span></div>
    </div>
    <h2>Period <span id="currentPeriod">1</span> of <span id="totalPeriods">6</span></h2>

    <div id="investmentCardsContainer"></div>
    <button class="submit-button" onclick="submitRound()">Submit</button>
</div>

<script>
    // Array to store game results for each round
    const gameData = [];

    // Main game variables
    const gameId = 'game_' + Date.now(); // Unique game ID
    let budget = 500;         // Starting budget of $500
    let totalValue = 0;       // Initial total value is zero
    let currentRound = 1;     // Start from round 1
    const totalRounds = 10;    // Total number of rounds
    let shockStandardDeviation = 0.3; // Default standard deviation for lognormal shocks
    let useShocks = false;    // Toggle to determine if shocks are used
    const numInvestmentCards = 1; // Number of investment cards presented each round
    let currentInvestmentData = generateInvestmentValues(numInvestmentCards);

    // Function to sync slider with number input
        function syncSlider(inputId, sliderId) {
        const input = document.getElementById(inputId);
        const slider = document.getElementById(sliderId);
        slider.value = input.value;
    }

    // Function to sync number input with slider
    function syncInput(sliderId, inputId) {
        const slider = document.getElementById(sliderId);
        const input = document.getElementById(inputId);
        input.value = slider.value;
    }
    // Display initial values on the UI
    document.getElementById("budget").textContent = `$${budget.toLocaleString()}`;
    document.getElementById("totalValue").textContent = totalValue;
    document.getElementById("currentPeriod").textContent = currentRound;
    document.getElementById("totalPeriods").textContent = totalRounds;

    // Function to generate a lognormal shift (used for generating shocks each period)
    function getLognormalShift(mean, stdev) {
        const u1 = Math.random();
        const u2 = Math.random();
        const standardNormal = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        return Math.exp(mean + stdev * standardNormal);
    }

    // Function to generate investment card values each round
    function generateInvestmentValues(numCards) {
        const investmentData = [];
        for (let i = 0; i < numCards; i++) {
            let investmentValue;
            let investmentCost;

            if (useShocks) {
                const shock = getLognormalShift(0, shockStandardDeviation);
                investmentValue = Math.round(shock * 100);
            } else {
                investmentValue = Math.round(Math.random() * 100);
            }

            investmentCost = Math.round(Math.random() * 100);
            investmentData.push({
                investmentValue,
                investmentCost
            });
        }
        return investmentData;
    }

  // Function to reset inputs and generate new investment cards for the current round
function resetInputs() {
    const investmentCardsContainer = document.getElementById("investmentCardsContainer");
    investmentCardsContainer.innerHTML = ""; // Clear previous cards

    // Use currentInvestmentData to regenerate cards
    currentInvestmentData.forEach((data, index) => {
        const cardHtml = `
            <div class="investment-card">
                <h3>Investment ${index + 1}</h3>
                <div class="value">Cost: $0 - $100 | Value: <span id="investmentValue${index}">${data.investmentValue}</span></div>
                <input type="number" id="investmentInput${index}" min="0" max="100" placeholder="Enter Amount" 
                       oninput="syncSlider('investmentInput${index}', 'investmentSlider${index}');">
                <div class="slider-container">
                    <input type="range" id="investmentSlider${index}" min="0" max="100" 
                           oninput="syncInput('investmentSlider${index}', 'investmentInput${index}');">
                </div>
            </div>
        `;
        investmentCardsContainer.insertAdjacentHTML('beforeend', cardHtml);
    });
}

    // Initial reset to display investment cards for the first round
    resetInputs();

    // Function to handle the submission of each round
    function submitRound() {
    let totalRoundValue = 0;
    let totalRoundCost = 0;

    for (let i = 0; i < currentInvestmentData.length; i++) {
        const investmentAmount = parseInt(document.getElementById(`investmentInput${i}`).value) || 0;
        const investmentValue = currentInvestmentData[i].investmentValue;
        const investmentCost = currentInvestmentData[i].investmentCost;

        if (investmentAmount >= investmentCost) {
            totalRoundValue += investmentValue;
            alert(`Investment ${i + 1} successful! Added $${investmentValue} to total value.`);
        } else {
            alert(`Investment ${i + 1} failed. Not enough to meet the required cost.`);
        }

        totalRoundCost += investmentAmount;
    }

    // Update total value and budget before any other actions
    totalValue += totalRoundValue;
    budget -= totalRoundCost;

    // Update UI with new budget and value
    document.getElementById("budget").textContent = `$${budget.toLocaleString()}`;
    document.getElementById("totalValue").textContent = totalValue;

    // Save round data
    saveRoundData(currentRound, totalRoundValue, totalRoundCost, currentInvestmentData, budget, totalValue);

    if (currentRound < totalRounds) {
        // Move to the next round
        currentRound++;
        document.getElementById("currentPeriod").textContent = currentRound;

        // Generate new investment data for next round and reset inputs
        currentInvestmentData = generateInvestmentValues(numInvestmentCards);
        resetInputs();
    } else {
        // End game and save results
        saveGameResults(); // This will now be called after UI updates
    }
}


    // Function to save data for each round
    function saveRoundData(round, totalRoundValue, totalRoundCost, investmentData, remainingBudget, totalValue) {
        investmentData.forEach((data, index) => {
            gameData.push({
                GameID: gameId,
                Round: round,
                Card: index + 1,
                ValueDisplayed: data.investmentValue,
                UserSpent: document.getElementById(`investmentInput${index}`).value || 0,
                ActualCost: data.investmentCost,
                RemainingBudget: remainingBudget,
                TotalValue: totalValue
            });
        });
    }

    // Function to convert game data to CSV format
    function convertToCSV(data) {
        const headers = [
            "GameID", "Round", "Card", "ValueDisplayed", "UserSpent", "ActualCost", "RemainingBudget", "TotalValue"
        ];

        const csvRows = data.map(row => headers.map(header => row[header]).join(","));
        return [headers.join(","), ...csvRows].join("\n");
    }

    // Function to download CSV file
    function downloadCSV(filename, csvContent) {
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.setAttribute("hidden", "");
        a.setAttribute("href", url);
        a.setAttribute("download", filename);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Function to save game results after the final round is completed
    function saveGameResults() {
    // Ask the user if they want to save the game results
    const saveConfirmation = confirm("Would you like to save your game results?");

    // If the user confirms, generate and download the CSV file
    if (saveConfirmation) {
        const csvContent = convertToCSV(gameData);
        const filename = `game_results.csv`;
        downloadCSV(filename, csvContent);
        alert("Your game results have been saved.");
    } else {
        alert("Game results were not saved.");
    }
}

</script>

</body>
</html>
