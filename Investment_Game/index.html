<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Investment Game</title>
<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f0f5;
        margin: 0;
    }

    .game-container {
        width: 300px;
        padding: 20px;
        border-radius: 10px;
        background-color: #3366cc;
        color: #fff;
        text-align: center;
    }

    .info-bar {
        font-size: 0.9em;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .investment-card {
        background-color: #ffffff;
        color: #333;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .investment-card h3 {
        margin: 5px 0;
        font-size: 1.1em;
        color: #3366cc;
    }

    .investment-card .value {
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .slider-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 10px 0;
    }

    input[type="number"], input[type="range"] {
        width: 100%;
    }

    input[type="range"] {
        margin-top: 5px;
    }

    .submit-button {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 10px 20px;
        font-size: 1em;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
    }

    .submit-button:disabled {
        background-color: #888;
    }
</style>
</head>
<body>

<div class="game-container">
    <div class="info-bar">
        <div>Budget Remaining: <span id="budget">$999,999</span></div>
        <div>Total Value: <span id="totalValue">123,456</span></div>
    </div>
    <h2>Period <span id="currentPeriod">1</span> of <span id="totalPeriods">Y</span></h2>

    <!-- Investment Card 1 -->
    <div class="investment-card">
        <h3>Investment 1</h3>
        <div class="value">Cost: <span id="investment1Range">$XX - $XXX</span> | Value: <span id="investment1Value">123</span></div>
        <input type="number" id="investment1Input" min="0" placeholder="Enter Amount" oninput="syncSlider('investment1Input', 'investment1Slider')">
        <div class="slider-container">
            <input type="range" id="investment1Slider" min="0" max="1000" oninput="syncInput('investment1Slider', 'investment1Input')">
        </div>
    </div>
    
    <div class="investment-card">
        <h3>Investment 2</h3>
        <div class="value">Cost: <span id="investment2Range">$XX - $XXX</span> | Value: <span id="investment2Value">123</span></div>
        <input type="number" id="investment2Input" min="0" placeholder="Enter Amount" oninput="syncSlider('investment2Input', 'investment2Slider')">
        <div class="slider-container">
            <input type="range" id="investment2Slider" min="0" max="1000" oninput="syncInput('investment2Slider', 'investment2Input')">
        </div>
    </div>

    <button class="submit-button" onclick="submitRound()">Submit</button>
</div>

<script>
    // Main game variables
    let budget = 10000;         // Starting budget of $10,000
    let totalValue = 0;         // Initial total value is zero
    let currentRound = 1;       // Start from round 1
    const totalRounds = 6;      // Total number of rounds
    let cumulativeShock = 1;    //variable to store cumulative shock, starting with 1
    let shockStandardDeviation = .3; // Default standard deviation for lognormal shocks
    let useCumulativeShocks = false; // Toggle to determine if cumulative shocks are used
    let penaltyPoints = 0;      // penalty points variable for running out of funds

    // Investment parameters
    const investment1BaseRange = [1000, 2000];   // Starting range for Investment 1
    const investment2BaseRange = [1000, 2000];    // Starting range for Investment 2
    const investment1BaseValue = 1000;            // Base mean value for Investment 1
    const valueIncreaseFactor = 1;             // 10% increase for Investment 2

    // Display initial values on the UI
    document.getElementById("budget").textContent = `$${budget.toLocaleString()}`;
    document.getElementById("totalValue").textContent = totalValue;
    document.getElementById("currentPeriod").textContent = currentRound;
    document.getElementById("totalPeriods").textContent = totalRounds;

// Function to generate a lognormal shift (used for generating shocks each period)
function getLognormalShift(mean, stdev) {
    // Generate a standard normal variable using the Box-Muller transform
    const u1 = Math.random();
    const u2 = Math.random();
    const standardNormal = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);

    // Scale by mean and stdev, then exponentiate to get a lognormal value
    return Math.exp(mean + stdev * standardNormal);
}

// Function to update investment card values each round
function generateInvestmentValues() {
    // Define mean base costs for Investment 1 and Investment 2
    const investment1BaseMean = 1000;  // Base mean for Investment 1
    const investment2BaseMean = 1000;  // Base mean for Investment 2

    let shock;

    if (useCumulativeShocks) {
        // Generate a new shock multiplier and accumulate it
        shock = getLognormalShift(0, shockStandardDeviation);
        cumulativeShock *= shock;  // Update cumulative shock by multiplying with the new shock
    } else {
        // If not using cumulative shocks, generate a new shock without accumulating
        cumulativeShock = getLognormalShift(0, shockStandardDeviation);
    }

    // Apply cumulative or independent shock to adjust mean cost for each investment
    const adjustedMean1 = Math.round(investment1BaseMean * cumulativeShock / 10) * 10;
    const adjustedMean2 = Math.round(investment2BaseMean * cumulativeShock / 10) * 10;

    // Define range width as a proportion of the adjusted mean
    const rangeProportion1 = 0.5;  // Range will be ±50% of the mean for Investment 1
    const rangeProportion2 = 0.70; // Range will be ±70% of the mean for Investment 2

    // Calculate range for Investment 1 based on the adjusted mean
    const investment1Range = [
        Math.max(10, Math.round((adjustedMean1 * (1 - rangeProportion1)) / 10) * 10),  // Lower bound is 50% below the mean
        Math.round((adjustedMean1 * (1 + rangeProportion1)) / 10) * 10                  // Upper bound is 50% above the mean
    ];

    // Calculate range for Investment 2 based on the adjusted mean
    const investment2Range = [
        Math.max(10, Math.round((adjustedMean2 * (1 - rangeProportion2)) / 10) * 10),   // Lower bound is 70% below the mean
        Math.round((adjustedMean2 * (1 + rangeProportion2)) / 10) * 10                  // Upper bound is 70% above the mean
    ];

    // Calculate actual costs by selecting a random value within the range
    const investment1ActualCost = Math.round(
        (investment1Range[0] + Math.random() * (investment1Range[1] - investment1Range[0])) / 10
    ) * 10;

    const investment2ActualCost = Math.round(
        (investment2Range[0] + Math.random() * (investment2Range[1] - investment2Range[0])) / 10
    ) * 10;

    // Calculate values for Investment 1 and Investment 2 using the cumulative or independent shock applied to their means
    const investment1Value = Math.round(adjustedMean1 * 2 / 10) * 10;
    const investment2Value = Math.round(adjustedMean2 * 2.10 / 10) * 10;

    // Update the UI with generated values
    document.querySelector("#investment1Value").textContent = investment1Value;
    document.querySelector("#investment2Value").textContent = investment2Value;

    // Update cost ranges in the UI
    document.querySelector("#investment1Range").textContent = `$${investment1Range[0]} - $${investment1Range[1]}`;
    document.querySelector("#investment2Range").textContent = `$${investment2Range[0]} - $${investment2Range[1]}`;

    // Update input fields and sliders
    document.querySelector("#investment1Input").setAttribute("min", investment1Range[0]);
    document.querySelector("#investment1Input").setAttribute("max", investment1Range[1]);
    document.querySelector("#investment1Slider").setAttribute("min", investment1Range[0]);
    document.querySelector("#investment1Slider").setAttribute("max", investment1Range[1]);
    document.querySelector("#investment2Input").setAttribute("min", investment2Range[0]);
    document.querySelector("#investment2Input").setAttribute("max", investment2Range[1]);
    document.querySelector("#investment2Slider").setAttribute("min", investment2Range[0]);
    document.querySelector("#investment2Slider").setAttribute("max", investment2Range[1]);

    // Save the actual costs and ranges for validation later, including mean value for Investment 1
    return {
        investment1Range,          // Including investment 1 range in return value
        investment1ActualCost,
        investment1Value,
        investment1Mean: adjustedMean1,  // Including the mean value for Investment 1
        investment2Range,          // Including investment 2 range in return value
        investment2ActualCost,
        investment2Value
    };
}

// Initial generation of investment values
let currentInvestmentData = generateInvestmentValues();

// Function to check and adjust if total investment exceeds remaining budget
function validateInvestment(inputId, sliderId) {
    const input = document.getElementById(inputId);
    const slider = document.getElementById(sliderId);
    let otherInvestment = 0;

    // Determine the other investment amount
    if (inputId === "investment1Input") {
        otherInvestment = parseInt(document.getElementById("investment2Input").value) || 0;
    } else {
        otherInvestment = parseInt(document.getElementById("investment1Input").value) || 0;
    }

    // Calculate the max allowable for this investment
    const maxAllowable = Math.max(0, budget - otherInvestment);

    // Adjust input and slider if the entered amount exceeds the allowable budget
    if (parseInt(input.value) > maxAllowable) {
        input.value = maxAllowable;
        slider.value = maxAllowable;
    } else {
        slider.value = input.value;
    }
}

// Sync the slider with the input box for Investment 1 and Investment 2
function syncInput(sliderId, inputId) {
    const slider = document.getElementById(sliderId);
    const input = document.getElementById(inputId);
    input.value = slider.value;
    validateInvestment(inputId, sliderId);
}

function syncSlider(inputId, sliderId) {
    const input = document.getElementById(inputId);
    const slider = document.getElementById(sliderId);

    let value = parseInt(input.value);
    if (isNaN(value)) {
        value = 0;
    }

    input.value = value;
    slider.value = value;
    validateInvestment(inputId, sliderId);
}

// Function to reset inputs and sliders at the start of each round
function resetInputs() {
    document.getElementById("investment1Input").value = '';
    document.getElementById("investment1Slider").value = document.getElementById("investment1Slider").min;
    document.getElementById("investment2Input").value = '';
    document.getElementById("investment2Slider").value = document.getElementById("investment2Slider").min;
}

// Generate a unique Game ID (e.g., using timestamp)
const gameId = 'game_' + Date.now();

// Array to store game results for each round
const gameData = [];

// Function to save data for each round
function saveRoundData(round, investment1, investment2, endingBudget, endingValue) {
    gameData.push({
        GameID: gameId,
        Round: round,
        Investment1RangeMin: investment1.range[0],
        Investment1RangeMax: investment1.range[1],
        Investment1Value: investment1.value,
        Investment1Cost: investment1.cost,
        Investment1Spent: investment1.spent,
        Investment2RangeMin: investment2.range[0],
        Investment2RangeMax: investment2.range[1],
        Investment2Value: investment2.value,
        Investment2Cost: investment2.cost,
        Investment2Spent: investment2.spent,
        EndingBudget: endingBudget,
        EndingValue: endingValue
    });
}

// Function to convert game data to CSV format
function convertToCSV(data) {
    const headers = [
        "GameID", "Round", "Investment1RangeMin", "Investment1RangeMax", "Investment1Value", 
        "Investment1Cost", "Investment1Spent", "Investment2RangeMin", "Investment2RangeMax", 
        "Investment2Value", "Investment2Cost", "Investment2Spent", "EndingBudget", "EndingValue"
    ];

    const csvRows = data.map(row => headers.map(header => row[header]).join(","));
    return [headers.join(","), ...csvRows].join("\n");
}

// Function to download CSV file
function downloadCSV(filename, csvContent) {
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.setAttribute("hidden", "");
    a.setAttribute("href", url);
    a.setAttribute("download", filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Call this function after the final round is completed
// Function to save game results with user confirmation
function saveGameResults() {
    // Ask the user if they want to save the game results
    const saveConfirmation = confirm("Would you like to save your game results?");

    // If the user confirms, generate and download the CSV file
    if (saveConfirmation) {
        const csvContent = convertToCSV(gameData);
        const filename = `${gameId}_game_results.csv`;
        downloadCSV(filename, csvContent);
        alert("Your game results have been saved.");
    } else {
        alert("Game results were not saved.");
    }
}


// Function to handle the submission of each round
function submitRound() {
    const investment1Amount = parseInt(document.getElementById("investment1Input").value) || 0;
    const investment2Amount = parseInt(document.getElementById("investment2Input").value) || 0;

    // Get the mean value for Investment 1 from current investment data
    const meanInvestment1 = currentInvestmentData.investment1Mean;

    // Check if the player spent less than the mean value on Investment 1
    if (investment1Amount < meanInvestment1) {
        // Calculate penalty as a proportion of the difference
        const penaltyDifference = meanInvestment1 - investment1Amount; // Only consider the difference if under the mean
        let penalty = penaltyDifference * 0.1; // Penalty is 10% of the difference
        penalty = Math.round(penalty); // Round the penalty to ensure no decimals
        penaltyPoints += penalty;

        // Apply penalty to the total value
        totalValue -= penalty;
        if (totalValue < 0) {
            totalValue = 0; // Ensure total value doesn't go below zero
        }

        alert(`Penalty applied! You must spend at least the mean on Investment 1. Penalty deducted from total value: $${penalty}`);
    }

    // Check if investment meets or exceeds actual costs and update values
    if (investment1Amount >= currentInvestmentData.investment1ActualCost) {
        totalValue += currentInvestmentData.investment1Value;
        alert(`Investment 1 successful! Added $${currentInvestmentData.investment1Value} to total value.`);
    } else {
        alert("Investment 1 failed. Not enough to meet the cost.");
    }

    if (investment2Amount >= currentInvestmentData.investment2ActualCost) {
        totalValue += currentInvestmentData.investment2Value;
        alert(`Investment 2 successful! Added $${currentInvestmentData.investment2Value} to total value.`);
    } else {
        alert("Investment 2 failed. Not enough to meet the cost.");
    }

    // Deduct the amounts spent from the budget
    budget -= (investment1Amount + investment2Amount);
    document.getElementById("budget").textContent = `$${budget.toLocaleString()}`;
    document.getElementById("totalValue").textContent = totalValue;

        // Prepare for the next round or save game results if the final round is over
    if (currentRound < totalRounds) {
        currentRound++;
        document.getElementById("currentPeriod").textContent = currentRound;
        currentInvestmentData = generateInvestmentValues();
        resetInputs(); // Reset input fields and sliders
    } else {
        alert("Game over!");
        saveGameResults();
    }
}




    // Display end-of-game summary
    function displayEndSummary() {
        alert(`Game Summary:\nTotal Value: $${totalValue}\nBudget Left: $${budget}\nMarginal Value (Value/Cost): ${(totalValue / (10000 - budget)).toFixed(2)}`);
    }
</script>

</body>
</html>
